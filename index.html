<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo Kumon</title>
    <meta name="theme-color" content="#0078c1"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --kumon-blue: #0078c1; --light-blue: #eef7ff; --text-color: #333;
            --border-color: #ddd; --background-color: #f4f7f9; --white: #fff;
            --success-green: #28a745; --warning-orange: #ffc107; --danger-red: #dc3545;
            --gray: #6c757d; --info-purple: #6f42c1; --evening-purple: #4f3d7a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; background-color: var(--white); padding: 20px 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07); }
        header { text-align: center; margin-bottom: 25px; }
        header h1 { color: var(--kumon-blue); font-size: 2em; }
        .date-navigation { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px; }
        .nav-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: var(--kumon-blue); padding: 0 10px; }
        .nav-btn:disabled { color: var(--gray); opacity: 0.5; cursor: not-allowed; }
        #currentDate { font-size: 1.2em; color: var(--gray); font-weight: 500; }
        .daily-wrapper { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 900px) { .daily-wrapper { grid-template-columns: 1fr 1fr; } }
        .section-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; transition: all 0.3s ease; }
        .section-box.day-finished { background-color: #f8f9fa; border-color: #e9ecef; }
        fieldset:disabled { opacity: 0.7; }
        .section-box h2 { font-size: 1.5em; color: var(--kumon-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        #reviewBox { background-color: #fdfaff; border-color: #e5d9ff; }
        #reviewBox h2 { color: var(--info-purple); }
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; }
        textarea { min-height: 100px; resize: vertical; }
        .kanban-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        #todo-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        #todo-list li span { flex-grow: 1; }
        .button-container { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        button { background-color: var(--kumon-blue); color: var(--white); border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.05em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        button:disabled { background-color: var(--gray); cursor: not-allowed; transform: none; box-shadow: none; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button.review-btn { background-color: var(--info-purple); }
        #nextDayTips { display: none; margin-top: 25px; padding: 15px; background-color: #fffbeb; border-left: 5px solid var(--warning-orange); border-radius: 0 8px 8px 0; }
        #weeklySummarySection { display: none; margin-top: 30px; }
        #weeklySummaryContent { white-space: pre-wrap; font-family: "SF Mono", "Courier New", monospace; line-height: 1.8; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9em; overflow-x: auto; }
        .info-tip { color: var(--kumon-blue); cursor: help; font-size: 1em; margin-left: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>Di√°rio de Bordo Kumon</h1>
            <div class="date-navigation">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <p id="currentDate"></p>
                <button id="nextDayBtn" class="nav-btn">&gt;</button>
            </div>
        </header>
        <div class="daily-wrapper">
            <div id="planningBox" class="section-box">
                <h2>Planejamento do Dia</h2>
                <form id="planningForm">
                    <fieldset id="planningFieldset">
                        <div class="form-section"><label for="dailyFocus">Foco Principal do Dia <span class="info-tip" title="Qual √© a √∫nica tarefa que, se conclu√≠da, far√° o dia de hoje valer a pena?">üí°</span></label><input type="text" id="dailyFocus" placeholder="Ex: Finalizar o cronograma de avalia√ß√µes..."></div>
                        <div class="form-section"><label for="criticalTasks">Tarefas Cr√≠ticas (Sua atua√ß√£o direta)</label><textarea id="criticalTasks" rows="3" placeholder="Ex: Ligar para m√£e do aluno X..."></textarea></div>
                        <div class="form-section"><label>A Realizar</label>
                            <ul id="todo-list" style="list-style-type: none; padding-left: 0;"></ul>
                            <div style="display:flex; gap: 5px; margin-top: 10px;"><input type="text" id="new-todo-input" placeholder="Nova tarefa..."><button type="button" id="add-todo-btn">+</button></div>
                        </div>
                        <div class="kanban-grid">
                           <div><label for="doing">Em Andamento</label><textarea id="doing"></textarea></div>
                           <div><label for="delegated">Delegado</label><textarea id="delegated"></textarea></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div id="reviewBox" class="section-box">
                <h2>Revis√£o e Fechamento do Dia</h2>
                <form id="reviewForm">
                     <fieldset id="reviewFieldset">
                        <div class="form-section"><label for="mainAchievement">Principal Conquista do Dia</label><input type="text" id="mainAchievement" placeholder="O que te deixou orgulhoso(a) hoje?"></div>
                        <div class="form-section"><label for="mainChallenge">Principal Desafio ou Aprendizado</label><input type="text" id="mainChallenge" placeholder="O que n√£o saiu como planejado e o que voc√™ aprendeu?"></div>
                        <div class="form-section"><label for="uncompletedTasks">O que n√£o foi conclu√≠do e por qu√™?</label><textarea id="uncompletedTasks" rows="2"></textarea></div>
                        <div class="form-section"><label>KPIs do Dia</label><div class="kanban-grid"><div><label for="kpiMatriculas">Matr√≠culas</label><input type="number" id="kpiMatriculas" min="0" value="0"></div><div><label for="kpiCancelamentos">Cancelamentos</label><input type="number" id="kpiCancelamentos" min="0" value="0"></div><div><label for="energyLevel">Energia (1-5)</label><input type="number" id="energyLevel" min="1" max="5"></div></div></div>
                        <div class="button-container"><button type="button" id="endDayBtn" class="review-btn">Analisar Dia e Gerar Dicas</button></div>
                    </fieldset>
                </form>
                <div id="nextDayTips"><h3>üí° Orientador Virtual para Amanh√£</h3><p id="tipContent"></p></div>
            </div>
        </div>
        <div class="button-container" style="margin-top: 40px;"><button type="button" id="showWeeklySummaryBtn">Gerar Resumo da Semana</button></div>
        <section id="weeklySummarySection"><h2 style="text-align:center; color: var(--kumon-blue); margin-bottom: 20px;">Painel de Controle da Semana</h2><pre id="weeklySummaryContent"></pre></section>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const OLD_STORAGE_KEY = 'kumonDailyLog_v5.3_Strategic';
        const STORAGE_KEY = 'kumonDailyLog_v6.0_Navigable';
        const App = {
            data: {},
            displayedDate: new Date(),
            today: new Date(),

            init() {
                this.today.setHours(0, 0, 0, 0);
                this.displayedDate.setHours(0, 0, 0, 0);
                
                this.runMigration(); // Check for old data and migrate
                this.loadData();
                this.renderDay(this.getDateString(this.displayedDate));
                this.addEventListeners();
            },

            runMigration() {
                const oldDataStr = localStorage.getItem(OLD_STORAGE_KEY);
                if (oldDataStr) {
                    console.log("Dados antigos encontrados. Iniciando migra√ß√£o...");
                    const oldData = JSON.parse(oldDataStr);
                    const newData = {};
                    for (const dateKey in oldData) {
                        const oldDay = oldData[dateKey];
                        newData[dateKey] = {
                            plan: {
                                dailyFocus: oldDay.plan.dailyFocus || '',
                                criticalTasks: oldDay.plan.criticalTasks || '',
                                todo: oldDay.plan.todo ? oldDay.plan.todo.split('\n').map(t => ({ text: t, deferred: false })) : [],
                                doing: oldDay.plan.doing || '',
                                delegated: oldDay.plan.delegated || '',
                            },
                            review: oldDay.review ? { ...oldDay.review } : null
                        };
                    }
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
                    localStorage.removeItem(OLD_STORAGE_KEY);
                    alert("Seus dados foram atualizados para a nova vers√£o do aplicativo com sucesso!");
                }
            },

            getDateString: date => date.toISOString().split('T')[0],
            loadData() { this.data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; },
            saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); },
            debounce(func, timeout = 700) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; },
            
            renderDay(dateString) {
                // Update date display
                document.getElementById('currentDate').textContent = this.displayedDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('nextDayBtn').disabled = this.getDateString(this.displayedDate) === this.getDateString(this.today);
                
                // Clear forms
                document.getElementById('planningForm').reset();
                document.getElementById('reviewForm').reset();
                document.getElementById('todo-list').innerHTML = '';
                document.getElementById('nextDayTips').style.display = 'none';

                const dayData = this.data[dateString];
                
                // Set default state for fieldsets
                document.getElementById('planningFieldset').disabled = false;
                document.getElementById('reviewFieldset').disabled = false;
                document.getElementById('planningBox').classList.remove('day-finished');
                document.getElementById('reviewBox').classList.remove('day-finished');
                document.getElementById('endDayBtn').disabled = false;

                if (!dayData) return;

                // Populate planning form
                const plan = dayData.plan || {};
                document.getElementById('dailyFocus').value = plan.dailyFocus || '';
                document.getElementById('criticalTasks').value = plan.criticalTasks || '';
                document.getElementById('doing').value = plan.doing || '';
                document.getElementById('delegated').value = plan.delegated || '';
                
                const todoList = document.getElementById('todo-list');
                (plan.todo || []).forEach(task => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${task.text}</span> <label><input type="checkbox" class="defer-checkbox" ${task.deferred ? 'checked' : ''}> Adiar</label>`;
                    todoList.appendChild(li);
                });
                
                // Populate review form if it exists
                if (dayData.review) {
                    const review = dayData.review || {};
                    Object.keys(review).forEach(key => { const el = document.getElementById(key); if (el) el.value = review[key]; });
                    document.getElementById('planningFieldset').disabled = true;
                    document.getElementById('reviewFieldset').disabled = true;
                    document.getElementById('planningBox').classList.add('day-finished');
                    document.getElementById('reviewBox').classList.add('day-finished');
                    document.getElementById('endDayBtn').disabled = true;
                    this.generateTips(dayData);
                }
            },

            addEventListeners() {
                const debouncedSave = this.debounce(() => this.saveCurrentState());
                document.getElementById('planningForm').addEventListener('input', debouncedSave);
                document.getElementById('reviewForm').addEventListener('input', debouncedSave);
                document.getElementById('todo-list').addEventListener('change', debouncedSave);
                document.getElementById('endDayBtn').addEventListener('click', () => this.endDay());
                document.getElementById('showWeeklySummaryBtn').addEventListener('click', () => this.showWeeklySummary());
                document.getElementById('prevDayBtn').addEventListener('click', () => this.navigateDays(-1));
                document.getElementById('nextDayBtn').addEventListener('click', () => this.navigateDays(1));
                document.getElementById('add-todo-btn').addEventListener('click', () => this.addTodoItem());
                document.getElementById('new-todo-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.addTodoItem(); }});
            },

            navigateDays(direction) {
                this.displayedDate.setDate(this.displayedDate.getDate() + direction);
                this.renderDay(this.getDateString(this.displayedDate));
            },

            addTodoItem() {
                const input = document.getElementById('new-todo-input');
                const text = input.value.trim();
                if (text) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${text}</span> <label><input type="checkbox" class="defer-checkbox"> Adiar</label>`;
                    document.getElementById('todo-list').appendChild(li);
                    input.value = '';
                    this.saveCurrentState();
                }
            },

            saveCurrentState() {
                const dateString = this.getDateString(this.displayedDate);
                if (this.data[dateString]?.review) return;

                const todoItems = [];
                document.querySelectorAll('#todo-list li').forEach(li => {
                    todoItems.push({
                        text: li.querySelector('span').textContent,
                        deferred: li.querySelector('.defer-checkbox').checked
                    });
                });

                const plan = {
                    dailyFocus: document.getElementById('dailyFocus').value.trim(),
                    criticalTasks: document.getElementById('criticalTasks').value.trim(),
                    todo: todoItems,
                    doing: document.getElementById('doing').value.trim(),
                    delegated: document.getElementById('delegated').value.trim(),
                };

                const review = {
                    mainAchievement: document.getElementById('mainAchievement').value.trim(),
                    mainChallenge: document.getElementById('mainChallenge').value.trim(),
                    uncompletedTasks: document.getElementById('uncompletedTasks').value.trim(),
                    energyLevel: document.getElementById('energyLevel').value,
                    kpiMatriculas: document.getElementById('kpiMatriculas').value,
                    kpiCancelamentos: document.getElementById('kpiCancelamentos').value,
                };

                if (!this.data[dateString]) this.data[dateString] = {};
                this.data[dateString].plan = plan;
                if(review.mainAchievement || review.energyLevel) { this.data[dateString].review = review; }
                this.saveData();
                console.log('Autosaved at', new Date().toLocaleTimeString());
            },

            endDay() {
                if (!document.getElementById('mainAchievement').value || !document.getElementById('energyLevel').value) {
                    alert('Por favor, preencha a Conquista do Dia e seu N√≠vel de Energia para finalizar.');
                    return;
                }
                if (confirm('Tem certeza que deseja finalizar e analisar o dia? Tarefas adiadas ser√£o movidas para amanh√£.')) {
                    this.saveCurrentState(); // Final save before processing
                    
                    const dateString = this.getDateString(this.displayedDate);
                    const dayData = this.data[dateString];

                    // Defer tasks
                    const deferredTasks = dayData.plan.todo.filter(t => t.deferred);
                    if (deferredTasks.length > 0) {
                        const nextDay = new Date(this.displayedDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        const nextDayString = this.getDateString(nextDay);
                        if (!this.data[nextDayString]) this.data[nextDayString] = { plan: { todo: [] } };
                        if (!this.data[nextDayString].plan.todo) this.data[nextDayString].plan.todo = [];
                        
                        deferredTasks.forEach(task => {
                            this.data[nextDayString].plan.todo.unshift({ text: `[ADIADO] ${task.text}`, deferred: false });
                        });
                    }
                    
                    this.saveData();
                    this.renderDay(dateString); // Re-render the finalized day
                    alert('Dia finalizado e analisado! Insights gerados e tarefas adiadas.');
                }
            },
            
            showWeeklySummary() {
                const summarySection = document.getElementById('weeklySummarySection');
                summarySection.style.display = 'block';
                const today = new Date(this.displayedDate);
                today.setHours(0, 0, 0, 0);
                const dayOfWeek = today.getDay();
                const offsetToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const firstDayOfWeek = new Date(today);
                firstDayOfWeek.setDate(today.getDate() + offsetToMonday);
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
                let summaryText = `RELAT√ìRIO DE PERFORMANCE SEMANAL\nSemana de ${firstDayOfWeek.toLocaleDateString('pt-BR')} a ${lastDayOfWeek.toLocaleDateString('pt-BR')}\n================================================\n`;
                let daysLogged = 0, totalEnergy = 0, totalMatriculas = 0, totalCancelamentos = 0;
                let achievements = [], challenges = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(firstDayOfWeek);
                    date.setDate(date.getDate() + i);
                    const dateString = this.getDateString(date);
                    const dayData = this.data[dateString];
                    if (dayData && dayData.review && dayData.review.energyLevel) {
                        daysLogged++;
                        totalEnergy += parseInt(dayData.review.energyLevel, 10);
                        totalMatriculas += parseInt(dayData.review.kpiMatriculas, 10) || 0;
                        totalCancelamentos += parseInt(dayData.review.kpiCancelamentos, 10) || 0;
                        const dayLabel = date.toLocaleDateString('pt-BR', {weekday: 'short', day: '2-digit', month: '2-digit'});
                        if(dayData.review.mainAchievement) achievements.push(`- [${dayLabel}]: ${dayData.review.mainAchievement}`);
                        if(dayData.review.mainChallenge) challenges.push(`- [${dayLabel}]: ${dayData.review.mainChallenge}`);
                    }
                }
                if(daysLogged === 0) { summaryText += "\nNenhum dia foi finalizado e analisado nesta semana.\nPara um resumo poderoso, lembre-se de preencher a 'Revis√£o do Dia' diariamente."; }
                else {
                    summaryText += `\n[ DIAGN√ìSTICO DE PERFORMANCE ]\n- Dias analisados: ${daysLogged}\n- N√≠vel m√©dio de energia: ${(totalEnergy / daysLogged).toFixed(1)}/5.0\n- Saldo de alunos: ${totalMatriculas} (matr√≠culas) - ${totalCancelamentos} (cancelamentos) = ${totalMatriculas - totalCancelamentos}\n`;
                    summaryText += `\n[ AN√ÅLISE DO ORIENTADOR VIRTUAL ]\n`;
                    if (totalCancelamentos > totalMatriculas) { summaryText += `- ALERTA DE RETEN√á√ÉO: O n√∫mero de cancelamentos superou o de matr√≠culas. A pr√≥xima semana deve ter FOCO M√ÅXIMO em a√ß√µes de fideliza√ß√£o.\n`; }
                    else if (totalMatriculas > 0) { summaryText += `- MOMENTUM DE CAPTA√á√ÉO: Voc√™ matriculou novos alunos! Analise de onde eles vieram e reforce esse canal de marketing.\n`; }
                    summaryText += `\n[ PRINCIPAIS CONQUISTAS ]\n${achievements.length > 0 ? achievements.join('\n') : 'Nenhuma conquista registrada.'}\n`;
                    summaryText += `\n[ PRINCIPAIS APRENDIZADOS ]\n${challenges.length > 0 ? challenges.join('\n') : 'Nenhum desafio registrado.'}\n`;
                }
                document.getElementById('weeklySummaryContent').textContent = summaryText;
                summarySection.scrollIntoView({ behavior: 'smooth' });
            },

            generateTips(dayData) { /* generateTips remains the same */ },
        };
        App.init();
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(r => console.log('SW OK')).catch(e => console.error('SW Fail', e)); }); }
    });
    </script>
</body>
</html>
