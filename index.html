<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo Kumon v8.final</title>
    <style>
        :root {
            --kumon-blue: #0078c1;
            --kumon-red-accent: #d62828;
            --light-blue: #eaf6ff;
            --text-color: #333;
            --border-color: #d1e9f6;
            --background-color: #f9fcff;
            --white: #ffffff;
            --gray: #888;
            --success: #28a745;
            --warning: #ffc107;
            --info-purple: #6f42c1;
            --header-bg: #f8f9fa;
            --recovery-btn-bg: #fca311;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 120, 193, 0.1);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        header {
            background-color: var(--header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            color: var(--kumon-blue);
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .date-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        #currentDate {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--kumon-blue);
        }

        .nav-btn {
            background: var(--kumon-blue);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background-color: #005a9e;
            transform: scale(1.1);
        }

        main {
            padding: 20px;
        }
        
        .section-box, fieldset {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        fieldset {
            border: 1px solid var(--border-color);
        }

        h2, h3 {
            color: var(--kumon-blue);
            border-bottom: 2px solid var(--light-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--kumon-blue);
            box-shadow: 0 0 8px rgba(0, 120, 193, 0.25);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #endDayBtn {
            background-color: var(--success);
            color: var(--white);
        }

        #endDayBtn.edit-mode {
            background-color: var(--warning);
            color: var(--text-color);
        }

        #showWeeklySummaryBtn {
            background-color: var(--info-purple);
            color: var(--white);
        }
        
        .download-btn {
            background-color: var(--gray);
            color: var(--white);
        }

        #recoveryBtn {
            background-color: var(--recovery-btn-bg);
            color: var(--white);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #todo-section .todo-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #todo-section input {
            flex-grow: 1;
        }

        #add-todo-btn {
            background-color: var(--kumon-blue);
            color: var(--white);
            padding: 0 20px;
        }

        #todo-list {
            list-style: none;
        }

        #todo-list li {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        #todo-list li:last-child {
            border-bottom: none;
        }

        #todo-list li:hover {
            background-color: #f9f9f9;
        }
        
        #todo-list input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        #todo-list span {
            flex-grow: 1;
        }
        
        #todo-list .delete-todo-btn {
            background-color: transparent;
            border: none;
            color: var(--kumon-red-accent);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #todo-list .delete-todo-btn:hover {
            background-color: #ffebee;
        }

        #kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        fieldset:disabled {
            opacity: 0.7;
            background-color: #f8f8f8;
            pointer-events: none; /* This is key to prevent interaction */
        }
        
        #weeklySummarySection, #nextDayTips {
            display: none; /* Hidden by default */
            margin-top: 20px;
            padding: 20px;
            background-color: var(--light-blue);
            border-radius: 8px;
        }

        #weeklySummaryContent, #tipContent {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        #actionBank details {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        #actionBank summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            background-color: var(--light-blue);
        }

        #actionBank-content {
            padding: 15px;
        }

        .action-category {
            margin-bottom: 15px;
        }
        
        .action-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-item:hover {
            background-color: #e0e0e0;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--header-bg);
            color: var(--gray);
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Di√°rio de Bordo Kumon</h1>
            <div class="date-navigation">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <p id="currentDate"></p>
                <button id="nextDayBtn" class="nav-btn">&gt;</button>
            </div>
        </header>

        <main>
            <section id="settingsBox" class="section-box">
                <div class="form-section">
                    <label for="userName">Nome do Gestor(a):</label>
                    <input type="text" id="userName" placeholder="Identifique-se para registrar o hist√≥rico">
                </div>
            </section>
            
            <section id="actionBank" class="section-box">
                <details>
                    <summary>üí° Banco de A√ß√µes Estrat√©gicas (Clique para expandir)</summary>
                    <div id="actionBank-content">
                        <!-- Content will be populated by JS -->
                    </div>
                </details>
            </section>

            <div class="daily-wrapper">
                <fieldset id="planningFieldset">
                    <h2>üóìÔ∏è Planejamento do Dia</h2>
                    <form id="planningForm">
                        <div class="form-section">
                            <label for="dailyFocus">üéØ Foco Principal do Dia</label>
                            <input type="text" id="dailyFocus" placeholder="Qual √© a √∫nica tarefa que, se conclu√≠da, far√° o dia valer a pena?">
                        </div>
                        <div class="form-section">
                            <label for="criticalTasks">‚ö° Tarefas Cr√≠ticas (Sua atua√ß√£o direta)</label>
                            <textarea id="criticalTasks" rows="3" placeholder="Ex: Ligar para m√£e do aluno X..."></textarea>
                        </div>
                        <div id="todo-section" class="form-section">
                            <label for="new-todo-input">üìã A Realizar</label>
                            <div class="todo-input-group">
                                <input type="text" id="new-todo-input" placeholder="Adicionar nova tarefa...">
                                <button type="button" id="add-todo-btn" class="btn">+</button>
                            </div>
                            <ul id="todo-list"></ul>
                        </div>
                        <div class="form-section">
                            <label for="delegated">ü§ù Delegado</label>
                            <textarea id="delegated" rows="3" placeholder="Tarefas ou processos delegados hoje..."></textarea>
                        </div>
                    </form>
                </fieldset>

                <fieldset id="reviewFieldset">
                    <h2>üßê Revis√£o e Fechamento do Dia</h2>
                    <form id="reviewForm">
                        <div class="form-section">
                            <label for="mainAchievement">üèÜ Conquista Principal</label>
                            <input type="text" id="mainAchievement" placeholder="O que te deixou orgulhoso(a) hoje?">
                        </div>
                        <div class="form-section">
                            <label for="mainChallenge">üßó Principal Desafio/Aprendizado</label>
                            <input type="text" id="mainChallenge" placeholder="O que n√£o saiu como planejado e o que voc√™ aprendeu?">
                        </div>
                        <div class="form-section">
                            <label for="uncompletedTasks"> unfinished Tarefas n√£o conclu√≠das e por qu√™?</label>
                            <textarea id="uncompletedTasks" rows="2"></textarea>
                        </div>
                        <div id="kpi-grid">
                            <div class="form-section">
                                <label for="kpiMatriculas">üìà Matr√≠culas</label>
                                <input type="number" id="kpiMatriculas" min="0" value="0">
                            </div>
                            <div class="form-section">
                                <label for="kpiCancelamentos">üìâ Cancelamentos</label>
                                <input type="number" id="kpiCancelamentos" min="0" value="0">
                            </div>
                        </div>
                         <div class="form-section">
                            <label for="energyLevel">‚ö° N√≠vel de Energia (1 a 5)</label>
                            <input type="range" id="energyLevel" min="1" max="5" value="3">
                        </div>
                    </form>
                </fieldset>
            </div>
            
            <div class="button-container">
                <button id="endDayBtn" class="btn">Analisar e Finalizar Dia</button>
                <button id="showWeeklySummaryBtn" class="btn">Gerar Resumo da Semana</button>
            </div>

            <section id="nextDayTips">
                <h3>üí° Orientador Virtual para Amanh√£</h3>
                <pre id="tipContent"></pre>
            </section>
            
            <section id="weeklySummarySection">
                <h2>üìä Painel de Controle da Semana</h2>
                <pre id="weeklySummaryContent"></pre>
                <div class="button-container">
                     <button id="downloadDailyBtn" class="btn download-btn">Download Relat√≥rio Di√°rio</button>
                     <button id="downloadWeeklyBtn" class="btn download-btn">Download Relat√≥rio Semanal</button>
                </div>
            </section>
        </main>

        <footer>
            <p>Desenvolvido com ü§ñ, por thIAguinho Solu√ß√µes</p>
            <div class="button-container">
                <button id="recoveryBtn" class="btn">üÜò Modo de Recupera√ß√£o de Dados</button>
            </div>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const App = {
            // --- STATE ---
            displayedDate: new Date(),
            isEditing: true,
            userSettings: { name: '' },
            
            // --- CONSTANTS ---
            // Using a new, final key to avoid conflicts
            STORAGE_KEYS: {
                // New definitive key format for daily logs
                DATA_PREFIX: 'kumonDailyLog_v8.final_', 
                // Settings key
                USER_SETTINGS: 'kumonUserSettings_v8.final',
                // Legacy keys for migration
                LEGACY_KEYS: [
                    'kumonDailyLog_v6.0_Navigable',
                    'kumonDailyLog_v8.1_DeepDiveMentor',
                    'kumonDailyLog_v8.0_Mentor',
                    'kumonDailyLog_v8.2_Recovered'
                ]
            },

            // --- DOM ELEMENTS ---
            elements: {
                currentDate: document.getElementById('currentDate'),
                prevDayBtn: document.getElementById('prevDayBtn'),
                nextDayBtn: document.getElementById('nextDayBtn'),
                userName: document.getElementById('userName'),
                planningFieldset: document.getElementById('planningFieldset'),
                reviewFieldset: document.getElementById('reviewFieldset'),
                endDayBtn: document.getElementById('endDayBtn'),
                // Planning Form
                dailyFocus: document.getElementById('dailyFocus'),
                criticalTasks: document.getElementById('criticalTasks'),
                todoList: document.getElementById('todo-list'),
                newTodoInput: document.getElementById('new-todo-input'),
                addTodoBtn: document.getElementById('add-todo-btn'),
                delegated: document.getElementById('delegated'),
                // Review Form
                mainAchievement: document.getElementById('mainAchievement'),
                mainChallenge: document.getElementById('mainChallenge'),
                uncompletedTasks: document.getElementById('uncompletedTasks'),
                kpiMatriculas: document.getElementById('kpiMatriculas'),
                kpiCancelamentos: document.getElementById('kpiCancelamentos'),
                energyLevel: document.getElementById('energyLevel'),
                // Action Bank
                actionBankContent: document.getElementById('actionBank-content'),
                // Summaries & Tips
                weeklySummarySection: document.getElementById('weeklySummarySection'),
                weeklySummaryContent: document.getElementById('weeklySummaryContent'),
                nextDayTips: document.getElementById('nextDayTips'),
                tipContent: document.getElementById('tipContent'),
                // Buttons
                showWeeklySummaryBtn: document.getElementById('showWeeklySummaryBtn'),
                downloadDailyBtn: document.getElementById('downloadDailyBtn'),
                downloadWeeklyBtn: document.getElementById('downloadWeeklyBtn'),
                recoveryBtn: document.getElementById('recoveryBtn'),
            },

            // --- INITIALIZATION ---
            init() {
                this.loadUserSettings();
                this.populateActionBank();
                this.addEventListeners();
                this.renderDay(this.getDateString(this.displayedDate));
            },
            
            // --- DATE HELPERS (CRITICAL FOR BUG FIX) ---
            /**
             * Converts a Date object to a standardized 'YYYY-MM-DD' string.
             * This is the cornerstone of the bug fix, ensuring no timezone issues.
             * @param {Date} date - The date object to convert.
             * @returns {string} - The date string in 'YYYY-MM-DD' format.
             */
            getDateString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            /**
             * Parses a 'YYYY-MM-DD' string back into a Date object, correcting for timezone offsets.
             * @param {string} dateString - The date string to convert.
             * @returns {Date} - The corresponding Date object.
             */
            parseDateString(dateString) {
                return new Date(dateString + 'T00:00:00');
            },
            
            // --- DATA PERSISTENCE (localStorage) ---
            loadData(dateString) {
                const key = this.STORAGE_KEYS.DATA_PREFIX + dateString;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },

            saveData(dateString, data) {
                const key = this.STORAGE_KEYS.DATA_PREFIX + dateString;
                localStorage.setItem(key, JSON.stringify(data));
            },

            loadUserSettings() {
                const settings = localStorage.getItem(this.STORAGE_KEYS.USER_SETTINGS);
                if (settings) {
                    this.userSettings = JSON.parse(settings);
                    this.elements.userName.value = this.userSettings.name || '';
                }
            },

            saveUserSettings() {
                this.userSettings.name = this.elements.userName.value.trim();
                localStorage.setItem(this.STORAGE_KEYS.USER_SETTINGS, JSON.stringify(this.userSettings));
            },

            // Debounce utility to prevent excessive writes to localStorage
            debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },

            // --- UI RENDERING ---
            renderDay(dateString) {
                // Set displayed date from the string
                this.displayedDate = this.parseDateString(dateString);

                // Update date display
                this.elements.currentDate.textContent = this.displayedDate.toLocaleDateString('pt-BR', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });

                // Load data for the date
                const dayData = this.loadData(dateString) || {};
                const plan = dayData.plan || {};
                const review = dayData.review || {};

                // Populate planning form
                this.elements.dailyFocus.value = plan.dailyFocus || '';
                this.elements.criticalTasks.value = plan.criticalTasks || '';
                this.elements.delegated.value = plan.delegated || '';
                
                // Populate to-do list
                this.elements.todoList.innerHTML = '';
                if (plan.todo && plan.todo.length > 0) {
                    plan.todo.forEach(task => this.createTodoElement(task));
                }

                // Populate review form
                this.elements.mainAchievement.value = review.mainAchievement || '';
                this.elements.mainChallenge.value = review.mainChallenge || '';
                this.elements.uncompletedTasks.value = review.uncompletedTasks || '';
                this.elements.kpiMatriculas.value = review.kpiMatriculas || 0;
                this.elements.kpiCancelamentos.value = review.kpiCancelamentos || 0;
                this.elements.energyLevel.value = review.energyLevel || 3;

                // Set editing state
                this.isEditing = dayData.isFinalized ? false : true;
                this.toggleFieldsDisabled();
            },

            createTodoElement(task) {
                const li = document.createElement('li');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.deferred;

                const span = document.createElement('span');
                span.textContent = task.text;
                if (task.deferred) {
                    span.style.textDecoration = 'line-through';
                    span.style.color = 'var(--gray)';
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-todo-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    li.remove();
                    this.saveCurrentState();
                };

                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(deleteBtn);
                
                checkbox.addEventListener('change', () => {
                     span.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
                     span.style.color = checkbox.checked ? 'var(--gray)' : 'var(--text-color)';
                     task.deferred = checkbox.checked;
                     this.saveCurrentState();
                });

                this.elements.todoList.appendChild(li);
            },

            toggleFieldsDisabled() {
                const isDisabled = !this.isEditing;
                this.elements.planningFieldset.disabled = isDisabled;
                this.elements.reviewFieldset.disabled = isDisabled;

                if (isDisabled) {
                    this.elements.endDayBtn.textContent = 'Editar Dia';
                    this.elements.endDayBtn.classList.add('edit-mode');
                } else {
                    this.elements.endDayBtn.textContent = 'Analisar e Finalizar Dia';
                    this.elements.endDayBtn.classList.remove('edit-mode');
                }
            },

            // --- EVENT HANDLING ---
            addEventListeners() {
                // Navigation
                this.elements.prevDayBtn.addEventListener('click', () => this.navigateDays(-1));
                this.elements.nextDayBtn.addEventListener('click', () => this.navigateDays(1));

                // Save on any input change (debounced)
                const debouncedSave = this.debounce(this.saveCurrentState, 500);
                const formElements = document.querySelectorAll('input, textarea');
                formElements.forEach(el => el.addEventListener('input', debouncedSave));

                // User settings
                this.elements.userName.addEventListener('change', () => this.saveUserSettings());
                
                // To-Do functionality
                this.elements.addTodoBtn.addEventListener('click', () => this.addTodoItem());
                this.elements.newTodoInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addTodoItem();
                    }
                });
                
                // Main action buttons
                this.elements.endDayBtn.addEventListener('click', () => this.toggleFinalizeDay());
                this.elements.showWeeklySummaryBtn.addEventListener('click', () => this.generateWeeklySummary());
                
                // Downloads
                this.elements.downloadDailyBtn.addEventListener('click', () => this.downloadReport('daily'));
                this.elements.downloadWeeklyBtn.addEventListener('click', () => this.downloadReport('weekly'));
                
                // Recovery
                this.elements.recoveryBtn.addEventListener('click', () => this.runMigration());
            },

            // --- CORE LOGIC & ACTIONS ---

            saveCurrentState() {
                if (!this.isEditing) return;

                const dateString = this.getDateString(this.displayedDate);
                
                const todoItems = Array.from(this.elements.todoList.querySelectorAll('li')).map(li => ({
                    text: li.querySelector('span').textContent,
                    deferred: li.querySelector('input[type="checkbox"]').checked
                }));

                const dayData = {
                    plan: {
                        dailyFocus: this.elements.dailyFocus.value.trim(),
                        criticalTasks: this.elements.criticalTasks.value.trim(),
                        todo: todoItems,
                        delegated: this.elements.delegated.value.trim(),
                    },
                    review: {
                        mainAchievement: this.elements.mainAchievement.value.trim(),
                        mainChallenge: this.elements.mainChallenge.value.trim(),
                        uncompletedTasks: this.elements.uncompletedTasks.value.trim(),
                        kpiMatriculas: this.elements.kpiMatriculas.value,
                        kpiCancelamentos: this.elements.kpiCancelamentos.value,
                        energyLevel: this.elements.energyLevel.value,
                    },
                    isFinalized: !this.isEditing,
                    lastUpdated: new Date().toISOString()
                };
                
                this.saveData(dateString, dayData);
                console.log(`Data saved for ${dateString}`);
            },
            
            navigateDays(direction) {
                this.displayedDate.setDate(this.displayedDate.getDate() + direction);
                this.renderDay(this.getDateString(this.displayedDate));
            },

            addTodoItem() {
                const text = this.elements.newTodoInput.value.trim();
                if (text) {
                    this.createTodoElement({ text, deferred: false });
                    this.elements.newTodoInput.value = '';
                    this.saveCurrentState();
                }
            },
            
            toggleFinalizeDay() {
                if (this.isEditing) {
                    // Action: Finalize Day
                    if (confirm('Tem certeza que deseja finalizar e analisar o dia? As tarefas pendentes ser√£o movidas para amanh√£.')) {
                        
                        // ** THE BUG FIX LOGIC STARTS HERE **

                        // 1. Get current and next day strings correctly
                        const currentDateString = this.getDateString(this.displayedDate);
                        const nextDayDate = new Date(this.displayedDate);
                        nextDayDate.setDate(nextDayDate.getDate() + 1);
                        const nextDayString = this.getDateString(nextDayDate);

                        // 2. Collect pending tasks
                        const deferredTasks = Array.from(this.elements.todoList.querySelectorAll('li'))
                            .map(li => ({
                                text: li.querySelector('span').textContent,
                                deferred: li.querySelector('input[type="checkbox"]').checked
                            }))
                            .filter(task => !task.deferred);
                        
                        // 3. Mark all current tasks as done before saving
                        Array.from(this.elements.todoList.querySelectorAll('li input[type="checkbox"]')).forEach(cb => cb.checked = true);
                        
                        // 4. Finalize and save the CURRENT day
                        this.isEditing = false;
                        this.saveCurrentState(); // Saves current day data with isFinalized = true

                        // 5. Load or create NEXT day's data
                        let nextDayData = this.loadData(nextDayString) || { plan: { todo: [] }, review: {}, isFinalized: false };
                        if (!nextDayData.plan) nextDayData.plan = {};
                        if (!nextDayData.plan.todo) nextDayData.plan.todo = [];

                        // 6. Prepend deferred tasks to the NEXT day
                        const tasksToCarryOver = deferredTasks.map(task => ({
                            text: `[ADIADO] ${task.text}`,
                            deferred: false
                        }));
                        nextDayData.plan.todo = [...tasksToCarryOver, ...nextDayData.plan.todo];

                        // 7. Save the updated NEXT day data
                        this.saveData(nextDayString, nextDayData);

                        alert(`Dia finalizado! ${deferredTasks.length} tarefa(s) adiada(s) para ${nextDayDate.toLocaleDateString('pt-BR')}.`);

                        // 8. Re-render the current day UI in locked state
                        this.renderDay(currentDateString);
                    }
                } else {
                    // Action: Edit Day
                    this.isEditing = true;
                    this.toggleFieldsDisabled();
                    // Save the change in state immediately
                    this.saveCurrentState(); 
                }
            },

            generateReportText(dateString, type = 'daily') {
                const data = this.loadData(dateString);
                if (!data) return `Nenhum dado encontrado para ${dateString}.\n`;

                const plan = data.plan || {};
                const review = data.review || {};
                const date = this.parseDateString(dateString);
                
                let report = `RELAT√ìRIO DE ${date.toLocaleDateString('pt-BR', { dateStyle: 'full' })}\n`;
                report += `=================================================\n\n`;
                
                report += `[PLANEJAMENTO]\n`;
                report += `üéØ Foco: ${plan.dailyFocus || 'N√£o definido'}\n`;
                report += `‚ö° Tarefas Cr√≠ticas: ${plan.criticalTasks || 'Nenhuma'}\n`;
                report += `ü§ù Delegado: ${plan.delegated || 'Nenhuma'}\n`;
                report += `üìã A Realizar:\n${(plan.todo && plan.todo.length > 0) ? plan.todo.map(t => `  - ${t.text}`).join('\n') : '  Nenhuma'}\n\n`;

                report += `[REVIS√ÉO]\n`;
                report += `üèÜ Conquista: ${review.mainAchievement || 'N√£o definida'}\n`;
                report += `üßó Desafio/Aprendizado: ${review.mainChallenge || 'N√£o definido'}\n`;
                report += ` unfinished Pend√™ncias: ${review.uncompletedTasks || 'Nenhuma'}\n`;
                report += `üìà Matr√≠culas: ${review.kpiMatriculas || 0}\n`;
                report += `üìâ Cancelamentos: ${review.kpiCancelamentos || 0}\n`;
                report += `‚ö° Energia: ${review.energyLevel || 'N/A'}/5\n`;
                
                return report;
            },

            generateWeeklySummary() {
                this.elements.weeklySummarySection.style.display = 'block';
                let summaryText = 'RESUMO DA PERFORMANCE SEMANAL\n\n';
                let totalMatriculas = 0;
                let totalCancelamentos = 0;
                let energySum = 0;
                let daysLogged = 0;

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(this.displayedDate);
                    date.setDate(date.getDate() - i);
                    const dateString = this.getDateString(date);
                    const data = this.loadData(dateString);
                    
                    summaryText += `--- ${date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' })} ---\n`;
                    if (data && data.review) {
                        summaryText += `Conquista: ${data.review.mainAchievement || '-'}\n`;
                        totalMatriculas += parseInt(data.review.kpiMatriculas || 0, 10);
                        totalCancelamentos += parseInt(data.review.kpiCancelamentos || 0, 10);
                        energySum += parseInt(data.review.energyLevel || 0, 10);
                        daysLogged++;
                    } else {
                        summaryText += `Nenhum dado registrado.\n`;
                    }
                    summaryText += '\n';
                }

                const avgEnergy = daysLogged > 0 ? (energySum / daysLogged).toFixed(1) : 'N/A';
                
                summaryText += `=========================\n`;
                summaryText += `TOTAL NA SEMANA:\n`;
                summaryText += `Matr√≠culas: ${totalMatriculas}\n`;
                summaryText += `Cancelamentos: ${totalCancelamentos}\n`;
                summaryText += `Saldo: ${totalMatriculas - totalCancelamentos}\n`;
                summaryText += `M√©dia de Energia: ${avgEnergy}/5\n`;

                this.elements.weeklySummaryContent.textContent = summaryText;
                this.elements.weeklySummarySection.scrollIntoView();
            },

            downloadReport(type) {
                let textContent = '';
                let filename = '';
                const todayStr = this.getDateString(this.displayedDate);

                if (type === 'daily') {
                    textContent = this.generateReportText(todayStr);
                    filename = `Relatorio_Diario_Kumon_${todayStr}.txt`;
                } else {
                    textContent = this.elements.weeklySummaryContent.textContent;
                    filename = `Relatorio_Semanal_Kumon_${todayStr}.txt`;
                }

                if (!textContent.trim()) {
                    alert('Nenhum conte√∫do para gerar o relat√≥rio.');
                    return;
                }

                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContent));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            },
            
            runMigration() {
                if (!confirm("Isso tentar√° encontrar dados de vers√µes antigas e import√°-los para o formato atual. Continuar?")) {
                    return;
                }
                
                let migratedCount = 0;
                let potentialData = {};
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Find all legacy keys
                    this.STORAGE_KEYS.LEGACY_KEYS.forEach(legacyPrefix => {
                         if (key.startsWith(legacyPrefix)) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                // Try to determine the date from legacy data
                                Object.keys(data).forEach(dateStr => {
                                    // A simple check if the key is a date string like '2025-10-08'
                                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                                       potentialData[dateStr] = data[dateStr];
                                    }
                                });
                            } catch (e) {
                                console.error(`Failed to parse legacy data from key ${key}:`, e);
                            }
                        }
                    });
                }
                
                Object.keys(potentialData).forEach(dateStr => {
                    const newDataKey = this.STORAGE_KEYS.DATA_PREFIX + dateStr;
                    if (!localStorage.getItem(newDataKey)) { // Don't overwrite new data
                       this.saveData(dateStr, potentialData[dateStr]);
                       migratedCount++;
                    }
                });

                if (migratedCount > 0) {
                    alert(`${migratedCount} dia(s) de dados antigos foram migrados com sucesso! Por favor, navegue pelos dias para verificar.`);
                    this.renderDay(this.getDateString(this.displayedDate)); // Refresh current view
                } else {
                    alert("Nenhum dado de vers√µes antigas compat√≠veis foi encontrado para migra√ß√£o.");
                }
            },

            populateActionBank() {
                const actions = {
                    "Pedag√≥gico & Reten√ß√£o de Alunos": [
                        "Analisar os 5 alunos mais antigos",
                        "Criar um 'quadro de honra' na unidade",
                        "Mapear 3 alunos em 'plat√¥' e agendar mini-reuni√£o",
                        "Verificar a programa√ß√£o de f√©rias de 5 alunos e antecipar orienta√ß√µes"
                    ],
                    "Gest√£o da Equipe & RH": [
                        "Realizar minitreinamento de 5 min",
                        "Dar um feedback positivo e espec√≠fico",
                        "Revisar a escala da pr√≥xima semana, buscando otimiza√ß√µes"
                    ],
                    "Comunica√ß√£o com os Pais": [
                        "Ligar para 2 pais 'apenas para dar um feedback positivo'",
                        "Enviar um comunicado sobre a import√¢ncia da rotina de estudos"
                    ]
                };

                let html = '';
                for (const category in actions) {
                    html += `<div class="action-category"><h4>${category}</h4>`;
                    actions[category].forEach(action => {
                        html += `<button class="action-item">${action}</button>`;
                    });
                    html += `</div>`;
                }
                this.elements.actionBankContent.innerHTML = html;
                
                // Add event listener for all action items
                this.elements.actionBankContent.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-item')) {
                        this.elements.newTodoInput.value = e.target.textContent;
                        this.addTodoItem();
                    }
                });
            }
        };

        App.init();
    });
    </script>
</body>
</html>

