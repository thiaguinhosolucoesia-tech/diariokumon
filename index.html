<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo Kumon</title>
    <meta name="theme-color" content="#0078c1"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --kumon-blue: #0078c1; --light-blue: #eef7ff; --text-color: #333;
            --border-color: #ddd; --background-color: #f4f7f9; --white: #fff;
            --success-green: #28a745; --warning-orange: #ffc107; --danger-red: #dc3545;
            --gray: #6c757d; --info-purple: #6f42c1; --evening-purple: #4f3d7a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; background-color: var(--white); padding: 20px 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07); }
        header { text-align: center; margin-bottom: 25px; }
        header h1 { color: var(--kumon-blue); font-size: 2em; }
        .date-navigation { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px; }
        .nav-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: var(--kumon-blue); padding: 0 10px; }
        .nav-btn:disabled { color: var(--gray); opacity: 0.5; cursor: not-allowed; }
        #currentDate { font-size: 1.2em; color: var(--gray); font-weight: 500; }
        .daily-wrapper { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 900px) { .daily-wrapper { grid-template-columns: 1fr 1fr; } }
        .section-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; transition: all 0.3s ease; }
        fieldset:disabled { opacity: 0.7; background-color: #f8f9fa; }
        .section-box h2 { font-size: 1.5em; color: var(--kumon-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        #reviewBox { background-color: #fdfaff; border-color: #e5d9ff; }
        #reviewBox h2 { color: var(--info-purple); }
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; }
        textarea { min-height: 100px; resize: vertical; }
        #todo-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        #todo-list li span { flex-grow: 1; }
        .button-container { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        button { background-color: var(--kumon-blue); color: var(--white); border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.05em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        button:disabled { background-color: var(--gray); cursor: not-allowed; transform: none; box-shadow: none; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button.save-btn { background-color: var(--success-green); }
        #nextDayTips, .edit-log { display: none; margin-top: 25px; padding: 15px; background-color: #fffbeb; border-left: 5px solid var(--warning-orange); border-radius: 0 8px 8px 0; font-size: 0.9em; }
        .edit-log { background-color: #f0f0f0; border-color: var(--gray); }
        #weeklySummarySection { display: none; margin-top: 30px; }
        #weeklySummaryContent { white-space: pre-wrap; font-family: "SF Mono", "Courier New", monospace; line-height: 1.8; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9em; overflow-x: auto; }
        footer { text-align: center; margin-top: 40px; color: var(--gray); font-size: 0.9em; }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>Di√°rio de Bordo Kumon</h1>
            <div class="date-navigation">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <p id="currentDate"></p>
                <button id="nextDayBtn" class="nav-btn">&gt;</button>
            </div>
        </header>

        <div id="settingsBox" class="section-box" style="margin-bottom: 20px;">
            <div class="form-section">
                <label for="userName">Seu Nome (para registro de edi√ß√µes)</label>
                <input type="text" id="userName" placeholder="Digite seu nome aqui...">
            </div>
        </div>

        <div class="daily-wrapper">
            <div id="planningBox" class="section-box">
                <h2>Planejamento do Dia</h2>
                <form id="planningForm">
                    <fieldset id="planningFieldset">
                        <div class="form-section"><label for="dailyFocus">Foco Principal do Dia</label><input type="text" id="dailyFocus" placeholder="Ex: Finalizar o cronograma de avalia√ß√µes..."></div>
                        <div class="form-section"><label for="criticalTasks">Tarefas Cr√≠ticas (Sua atua√ß√£o direta)</label><textarea id="criticalTasks" rows="3" placeholder="Ex: Ligar para m√£e do aluno X..."></textarea></div>
                        <div class="form-section"><label>A Realizar</label>
                            <ul id="todo-list" style="list-style-type: none; padding-left: 0;"></ul>
                            <div style="display:flex; gap: 5px; margin-top: 10px;"><input type="text" id="new-todo-input" placeholder="Nova tarefa..."><button type="button" id="add-todo-btn">+</button></div>
                        </div>
                        <div style="display: grid; gap: 20px; grid-template-columns: 1fr 1fr;">
                           <div><label for="doing">Em Andamento</label><textarea id="doing"></textarea></div>
                           <div><label for="delegated">Delegado</label><textarea id="delegated"></textarea></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div id="reviewBox" class="section-box">
                <h2>Revis√£o e Fechamento do Dia</h2>
                <form id="reviewForm">
                     <fieldset id="reviewFieldset">
                        <div class="form-section"><label for="mainAchievement">Principal Conquista</label><input type="text" id="mainAchievement"></div>
                        <div class="form-section"><label for="mainChallenge">Principal Desafio/Aprendizado</label><input type="text" id="mainChallenge"></div>
                        <div class="form-section"><label for="uncompletedTasks">O que n√£o foi conclu√≠do e por qu√™?</label><textarea id="uncompletedTasks" rows="2"></textarea></div>
                        <div class="form-section"><label>KPIs do Dia</label><div style="display: grid; gap: 15px; grid-template-columns: repeat(3, 1fr);"><div><label for="kpiMatriculas">Matr√≠culas</label><input type="number" id="kpiMatriculas" min="0" value="0"></div><div><label for="kpiCancelamentos">Cancelamentos</label><input type="number" id="kpiCancelamentos" min="0" value="0"></div><div><label for="energyLevel">Energia (1-5)</label><input type="number" id="energyLevel" min="1" max="5"></div></div></div>
                    </fieldset>
                </form>
                <div class="button-container">
                    <button type="button" id="editDayBtn">Editar Dia</button>
                    <button type="button" id="endDayBtn">Analisar e Finalizar Dia</button>
                </div>
                <div id="nextDayTips"><h3>üí° Orientador Virtual para Amanh√£</h3><p id="tipContent"></p></div>
                <div class="edit-log" id="editLog"></div>
            </div>
        </div>
        <div class="button-container" style="margin-top: 40px;"><button type="button" id="showWeeklySummaryBtn">Gerar Relat√≥rio da Semana</button></div>
        <section id="weeklySummarySection"><h2 style="text-align:center; color: var(--kumon-blue); margin-bottom: 20px;">Painel de Controle da Semana</h2><pre id="weeklySummaryContent"></pre></section>
    </main>
    <footer><p>Desenvolvido com ü§ñ, por thIAguinho Solu√ß√µes</p></footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const OLD_STORAGE_KEY_V6 = 'kumonDailyLog_v6.0_Navigable';
        const STORAGE_KEY = 'kumonDailyLog_v7.0_Editable';
        const USER_SETTINGS_KEY = 'kumonDiaryUserSettings';

        const App = {
            data: {},
            userSettings: { name: '' },
            displayedDate: new Date(),
            today: new Date(),
            isEditing: false,

            init() {
                this.today.setHours(0, 0, 0, 0);
                this.displayedDate.setHours(0, 0, 0, 0);
                
                this.runMigration();
                this.loadUserSettings();
                this.loadData();
                this.renderDay(this.getDateString(this.displayedDate));
                this.addEventListeners();
            },

            runMigration() {
                const oldDataStr = localStorage.getItem(OLD_STORAGE_KEY_V6);
                if (oldDataStr) {
                    const oldData = JSON.parse(oldDataStr);
                    const newData = {};
                    for (const dateKey in oldData) {
                        const oldDay = oldData[dateKey];
                        newData[dateKey] = {
                            ...oldDay,
                            log: [] // Add the new log property
                        };
                    }
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
                    localStorage.removeItem(OLD_STORAGE_KEY_V6);
                    alert("Seus dados foram atualizados para a nova vers√£o com hist√≥rico de edi√ß√µes!");
                }
            },
            
            loadUserSettings() {
                const settings = localStorage.getItem(USER_SETTINGS_KEY);
                if (settings) {
                    this.userSettings = JSON.parse(settings);
                }
                document.getElementById('userName').value = this.userSettings.name || '';
            },

            saveUserSettings() {
                this.userSettings.name = document.getElementById('userName').value.trim();
                localStorage.setItem(USER_SETTINGS_KEY, JSON.stringify(this.userSettings));
            },

            getDateString: date => date.toISOString().split('T')[0],
            loadData() { this.data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; },
            saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); },
            
            renderDay(dateString) {
                document.getElementById('currentDate').textContent = this.displayedDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('nextDayBtn').disabled = this.getDateString(this.displayedDate) === this.getDateString(this.today);
                
                document.getElementById('planningForm').reset();
                document.getElementById('reviewForm').reset();
                document.getElementById('todo-list').innerHTML = '';
                document.getElementById('nextDayTips').style.display = 'none';
                document.getElementById('editLog').style.display = 'none';

                const dayData = this.data[dateString];
                this.isEditing = false;
                
                if (!dayData || !dayData.review) { // Dia n√£o iniciado ou n√£o finalizado
                    this.isEditing = true;
                    document.getElementById('editDayBtn').style.display = 'none';
                    document.getElementById('endDayBtn').style.display = 'block';
                    document.getElementById('endDayBtn').textContent = 'Analisar e Finalizar Dia';
                } else { // Dia finalizado
                    document.getElementById('editDayBtn').style.display = 'block';
                    document.getElementById('editDayBtn').textContent = 'Editar Dia';
                    document.getElementById('endDayBtn').style.display = 'none';
                }
                
                this.toggleFieldsDisabled(!this.isEditing);

                if (!dayData) return;

                const plan = dayData.plan || {};
                document.getElementById('dailyFocus').value = plan.dailyFocus || '';
                document.getElementById('criticalTasks').value = plan.criticalTasks || '';
                document.getElementById('doing').value = plan.doing || '';
                document.getElementById('delegated').value = plan.delegated || '';
                
                const todoList = document.getElementById('todo-list');
                (plan.todo || []).forEach(task => this.createTodoElement(task));
                
                if (dayData.review) {
                    const review = dayData.review || {};
                    Object.keys(review).forEach(key => { const el = document.getElementById(key); if (el) el.value = review[key]; });
                    this.generateTips(dayData);
                }

                if (dayData.log && dayData.log.length > 0) {
                    const lastEdit = dayData.log[dayData.log.length - 1];
                    const editDate = new Date(lastEdit.timestamp).toLocaleString('pt-BR');
                    document.getElementById('editLog').textContent = `√öltima edi√ß√£o por ${lastEdit.user} em ${editDate}.`;
                    document.getElementById('editLog').style.display = 'block';
                }
            },

            toggleFieldsDisabled(isDisabled) {
                document.getElementById('planningFieldset').disabled = isDisabled;
                document.getElementById('reviewFieldset').disabled = isDisabled;
            },

            toggleEditMode() {
                const dateString = this.getDateString(this.displayedDate);
                const dayData = this.data[dateString];
                if (!dayData || !dayData.review) return; // Can't edit a non-finalized day

                this.isEditing = !this.isEditing;
                this.toggleFieldsDisabled(!this.isEditing);

                const editBtn = document.getElementById('editDayBtn');
                if (this.isEditing) {
                    editBtn.textContent = 'Salvar Altera√ß√µes';
                    editBtn.classList.add('save-btn');
                } else {
                    editBtn.textContent = 'Editar Dia';
                    editBtn.classList.remove('save-btn');
                    this.saveCurrentState(true); // Save with edit log
                    this.renderDay(dateString); // Re-render to show updated state
                }
            },
            
            addEventListeners() {
                document.getElementById('userName').addEventListener('change', () => this.saveUserSettings());
                document.getElementById('endDayBtn').addEventListener('click', () => this.endDay());
                document.getElementById('editDayBtn').addEventListener('click', () => this.toggleEditMode());
                document.getElementById('showWeeklySummaryBtn').addEventListener('click', () => this.showWeeklySummary());
                document.getElementById('prevDayBtn').addEventListener('click', () => this.navigateDays(-1));
                document.getElementById('nextDayBtn').addEventListener('click', () => this.navigateDays(1));
                document.getElementById('add-todo-btn').addEventListener('click', () => this.addTodoItem());
                document.getElementById('new-todo-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.addTodoItem(); }});
            },

            navigateDays(direction) {
                this.displayedDate.setDate(this.displayedDate.getDate() + direction);
                this.renderDay(this.getDateString(this.displayedDate));
            },

            addTodoItem() {
                const input = document.getElementById('new-todo-input');
                const text = input.value.trim();
                if (text) {
                    this.createTodoElement({ text, deferred: false });
                    input.value = '';
                    this.saveCurrentState(false);
                }
            },

            createTodoElement(task) {
                const li = document.createElement('li');
                li.innerHTML = `<span>${task.text}</span> <label><input type="checkbox" class="defer-checkbox" ${task.deferred ? 'checked' : ''}> Adiar</label>`;
                document.getElementById('todo-list').appendChild(li);
            },

            saveCurrentState(isEdit) {
                const dateString = this.getDateString(this.displayedDate);
                const todoItems = Array.from(document.querySelectorAll('#todo-list li')).map(li => ({
                    text: li.querySelector('span').textContent,
                    deferred: li.querySelector('.defer-checkbox').checked
                }));

                const plan = {
                    dailyFocus: document.getElementById('dailyFocus').value.trim(),
                    criticalTasks: document.getElementById('criticalTasks').value.trim(),
                    todo: todoItems,
                    doing: document.getElementById('doing').value.trim(),
                    delegated: document.getElementById('delegated').value.trim(),
                };
                const review = {
                    mainAchievement: document.getElementById('mainAchievement').value.trim(),
                    mainChallenge: document.getElementById('mainChallenge').value.trim(),
                    uncompletedTasks: document.getElementById('uncompletedTasks').value.trim(),
                    energyLevel: document.getElementById('energyLevel').value,
                    kpiMatriculas: document.getElementById('kpiMatriculas').value,
                    kpiCancelamentos: document.getElementById('kpiCancelamentos').value,
                };
                
                if (!this.data[dateString]) this.data[dateString] = { log: [] };
                this.data[dateString].plan = plan;
                if(review.mainAchievement || review.energyLevel) { this.data[dateString].review = review; }
                
                if (isEdit) {
                    this.data[dateString].log.push({
                        user: this.userSettings.name || 'Usu√°rio',
                        timestamp: new Date().toISOString()
                    });
                }

                this.saveData();
                console.log('State saved at', new Date().toLocaleTimeString());
            },

            endDay() {
                if (!document.getElementById('mainAchievement').value || !document.getElementById('energyLevel').value) {
                    alert('Por favor, preencha a Conquista do Dia e seu N√≠vel de Energia para finalizar.');
                    return;
                }
                if (confirm('Tem certeza que deseja finalizar e analisar o dia?')) {
                    this.saveCurrentState(false);
                    // Defer tasks logic...
                    const dateString = this.getDateString(this.displayedDate);
                    const dayData = this.data[dateString];
                    const deferredTasks = dayData.plan.todo.filter(t => t.deferred);
                    if (deferredTasks.length > 0) {
                        const nextDay = new Date(this.displayedDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        const nextDayString = this.getDateString(nextDay);
                        if (!this.data[nextDayString]) this.data[nextDayString] = { plan: { todo: [] }, log:[] };
                        if (!this.data[nextDayString].plan.todo) this.data[nextDayString].plan.todo = [];
                        deferredTasks.forEach(task => {
                            this.data[nextDayString].plan.todo.unshift({ text: `[ADIADO] ${task.text}`, deferred: false });
                        });
                    }
                    this.saveData();
                    this.renderDay(dateString);
                    alert('Dia finalizado e analisado! Insights gerados.');
                }
            },
            
            showWeeklySummary() {
                const summarySection = document.getElementById('weeklySummarySection');
                summarySection.style.display = 'block';
                
                const today = new Date(this.displayedDate);
                today.setHours(0, 0, 0, 0);
                const dayOfWeek = today.getDay();
                const offsetToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const firstDayOfWeek = new Date(today);
                firstDayOfWeek.setDate(today.getDate() + offsetToMonday);
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                let summaryText = `RELAT√ìRIO DE PERFORMANCE SEMANAL\nSemana de ${firstDayOfWeek.toLocaleDateString('pt-BR')} a ${lastDayOfWeek.toLocaleDateString('pt-BR')}\n================================================\n\n`;
                let daysData = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(firstDayOfWeek);
                    date.setDate(date.getDate() + i);
                    const dateString = this.getDateString(date);
                    const dayData = this.data[dateString];
                    if (dayData && dayData.review && dayData.review.energyLevel) {
                        daysData.push({ date, data: dayData });
                        const dayLabel = date.toLocaleDateString('pt-BR', {weekday: 'long', day: '2-digit', month: '2-digit'});
                        summaryText += `--- ${dayLabel.toUpperCase()} ---\n`;
                        summaryText += `  Foco: ${dayData.plan.dailyFocus || 'N√£o definido'}\n`;
                        summaryText += `  Conquista: ${dayData.review.mainAchievement || 'N√£o registrada'}\n`;
                        summaryText += `  Desafio: ${dayData.review.mainChallenge || 'N√£o registrado'}\n\n`;
                    }
                }

                if(daysData.length === 0) {
                    summaryText += "Nenhum dia foi finalizado e analisado nesta semana.\nPara um resumo poderoso, lembre-se de preencher a 'Revis√£o do Dia' diariamente.";
                } else {
                    summaryText += this.generateProfessionalAnalysis(daysData);
                }
                
                document.getElementById('weeklySummaryContent').textContent = summaryText;
                summarySection.scrollIntoView({ behavior: 'smooth' });
            },

            generateProfessionalAnalysis(daysData) {
                let analysis = "--- AN√ÅLISE PROFISSIONAL DA SEMANA ---\n";
                const totalDays = daysData.length;
                const totalMatriculas = daysData.reduce((sum, d) => sum + (parseInt(d.data.review.kpiMatriculas, 10) || 0), 0);
                const totalCancelamentos = daysData.reduce((sum, d) => sum + (parseInt(d.data.review.kpiCancelamentos, 10) || 0), 0);
                const avgEnergy = daysData.reduce((sum, d) => sum + (parseInt(d.data.review.energyLevel, 10) || 0), 0) / totalDays;

                analysis += `  Diagn√≥stico de KPIs:\n`;
                analysis += `    - Saldo de alunos: ${totalMatriculas} (matr√≠culas) - ${totalCancelamentos} (cancelamentos) = ${totalMatriculas - totalCancelamentos}\n`;
                analysis += `    - N√≠vel m√©dio de energia: ${avgEnergy.toFixed(1)}/5.0\n\n`;
                analysis += `  Recomenda√ß√µes Estrat√©gicas:\n`;
                if (totalCancelamentos > totalMatriculas) {
                    analysis += `    - ALERTA DE RETEN√á√ÉO: O balan√ßo de alunos foi negativo. A prioridade para a pr√≥xima semana deve ser a fideliza√ß√£o. Sugest√£o: Inicie a semana mapeando os alunos que est√£o em plat√¥ ou desmotivados e crie um plano de a√ß√£o para reconect√°-los.\n`;
                } else if (totalMatriculas > totalCancelamentos) {
                    analysis += `    - MOMENTUM DE CAPTA√á√ÉO: O balan√ßo de alunos foi positivo. Excelente! Analise a origem dessas novas matr√≠culas (indica√ß√£o, fachada, redes sociais?) e intensifique os esfor√ßos nesse canal espec√≠fico.\n`;
                } else {
                     analysis += `    - ESTABILIDADE: A unidade manteve o n√∫mero de alunos. √â um bom momento para focar na qualidade dos processos internos e no desenvolvimento da equipe, preparando o terreno para o pr√≥ximo ciclo de crescimento.\n`;
                }

                if (avgEnergy < 2.5) {
                    analysis += `    - GEST√ÉO DE ENERGIA: Seu n√≠vel de energia esteve consistentemente baixo. Isso √© um risco para a sustentabilidade da gest√£o. Para a pr√≥xima semana, identifique UMA tarefa operacional que possa ser delegada ou automatizada. Proteger sua energia √© uma atividade estrat√©gica.\n`;
                }
                
                return analysis;
            },
            
            generateTips(dayData) { /* generateTips remains the same */ },
        };
        App.init();
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(r => console.log('SW OK')).catch(e => console.error('SW Fail', e)); }); }
    });
    </script>
</body>
</html>
